<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>AOSP Android 10内置FridaGadget实践01 | Hi~,靓仔</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="背景想做frida持久化hook，通过搜索资料发现gadget可以。">
<meta property="og:type" content="article">
<meta property="og:title" content="AOSP Android 10内置FridaGadget实践01">
<meta property="og:url" content="https://me.debuglive.cn/2023/11/06/AOSP%20Android%2010%E5%86%85%E7%BD%AEFridaGadget%E5%AE%9E%E8%B7%B501/index.html">
<meta property="og:site_name" content="Hi~,靓仔">
<meta property="og:description" content="背景想做frida持久化hook，通过搜索资料发现gadget可以。">
<meta property="og:locale">
<meta property="og:image" content="https://book.debuglive.cn/gzh/ic_gzh.png">
<meta property="article:published_time" content="2023-11-06T02:53:19.000Z">
<meta property="article:modified_time" content="2023-11-09T02:37:59.641Z">
<meta property="article:author" content="黄大官AOSP">
<meta property="article:tag" content="AOSP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://book.debuglive.cn/gzh/ic_gzh.png">
  
    <link rel="alternate" href="/atom.xml" title="Hi~,靓仔" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hi~,靓仔</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">每天坚持写bug</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://me.debuglive.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-AOSP Android 10内置FridaGadget实践01" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/06/AOSP%20Android%2010%E5%86%85%E7%BD%AEFridaGadget%E5%AE%9E%E8%B7%B501/" class="article-date">
  <time class="dt-published" datetime="2023-11-06T02:53:19.000Z" itemprop="datePublished">2023-11-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android-AOSP%E5%AD%A6%E4%B9%A0/">Android AOSP学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      AOSP Android 10内置FridaGadget实践01
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>想做frida持久化hook，通过搜索资料发现gadget可以。</p>
<span id="more"></span>

<p>这是官方的资料：<a target="_blank" rel="noopener" href="https://frida.re/docs/gadget/">https://frida.re/docs/gadget/</a></p>
<p>这里有详细的使用方法，比如反编译apk插入so文件，如果这个app没有so库，就需要自己在application自己加代码load so，但是这些都不是我现在需要的操作。</p>
<p>我既然修改的是AOSP，在app加载的时候加载so就行了。</p>
<p>经过搜索资料发现了这个博客：<a target="_blank" rel="noopener" href="http://zhuoyue360.com/crack/78.html">http://zhuoyue360.com/crack/78.html</a></p>
<p>这里面应该学习了某个大佬的课程然后分享出来的，经过分析和实践验证了博客中的一部分内容是可行的，有一些重要的部分是没有的，但是主干思路有了之后剩下的部分有盼头了。</p>
<h3 id="实践与验证"><a href="#实践与验证" class="headerlink" title="实践与验证"></a>实践与验证</h3><p>环境：</p>
<p>AOSP 10 r41</p>
<p>pixel 3</p>
<p>Ubuntu 18.04</p>
<hr>
<h5 id="修改app的启动流程，在启动期间去加载so。"><a href="#修改app的启动流程，在启动期间去加载so。" class="headerlink" title="修改app的启动流程，在启动期间去加载so。"></a>修改app的启动流程，在启动期间去加载so。</h5><p>在<code>frameworks/base/core/java/android/app/ActivityThread.java</code>中的<code>handleBindApplication</code></p>
<p>方法中，找到<code>Application</code>创建之前的位置，经过我的测试<code>onCreate</code>之后加载so也可以的！加入如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//data是前面已经存在的app信息，获取到当前app的包名，用于判断某个目录下是否存在</span></span><br><span class="line"><span class="comment">//某个文件，文件存在做某事</span></span><br><span class="line"><span class="type">String</span> <span class="variable">curPkgName</span> <span class="operator">=</span> data.appInfo.packageName;</span><br><span class="line"><span class="type">int</span> <span class="variable">curUid</span> <span class="operator">=</span> Process.myUid();</span><br><span class="line"><span class="comment">//获取进程id，猜测大部分系统进程id都是10000内，应该是过滤了系统的app</span></span><br><span class="line"><span class="keyword">if</span> (curUid &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">  	<span class="comment">//这个类后面会给出来，是复制文件，判断文件夹等等用途</span></span><br><span class="line">    Persist.LOGD(<span class="string">&quot;curPkgName: &quot;</span> + curPkgName + <span class="string">&quot; curUid: &quot;</span> + curUid);</span><br><span class="line">    <span class="comment">//判断当前app是否激活了持久化hook，就是判断包目录下是否存在某个文件</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isPersist</span> <span class="operator">=</span> Persist.isEnablePersist(curPkgName);</span><br><span class="line">    Persist.LOGD(<span class="string">&quot;isPersist: &quot;</span> + isPersist);</span><br><span class="line">    <span class="keyword">if</span> (isPersist) &#123;</span><br><span class="line">        <span class="comment">//复制hook脚本到app安装目录下，然后加载gadget so</span></span><br><span class="line">        <span class="keyword">if</span>(Persist.doXiaojianbangPersist(appContext, curPkgName))&#123;</span><br><span class="line">            Persist.LOGD(<span class="string">&quot;doXiaojianbangPersist is ok&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            Persist.LOGD(<span class="string">&quot;doXiaojianbangPersist failed&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这阶段主要是判断app是否需要持久化hook，不是所有的app都需要这样，正常流程。</p>
<p>下面是<code>Persist</code>这个类的加入了，其实这个类加入到系统编译不需要这么麻烦，直接在<code>ActivityThread.java</code>的同级目录下创建这个类就行了，整个流程这个类其实就是给<code>ActivityThread.java</code>使用的，如果按照上面博客的操作还得给这个类配置白名单。</p>
<h5 id="在编译阶段复制so到system-lib下"><a href="#在编译阶段复制so到system-lib下" class="headerlink" title="在编译阶段复制so到system&#x2F;lib下"></a>在编译阶段复制so到system&#x2F;lib下</h5><p>在<code>/frameworks/base/cmds/</code>目录下创建一个自己的目录，把GitHub上面下载的gadget的so文件放到目录中。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases%E9%9A%8F%E4%BE%BF%E4%B8%8B%E8%BD%BD%E4%B8%80%E4%B8%AA%E7%89%88%E6%9C%AC%EF%BC%8C%E6%88%91%E4%B9%A0%E6%83%AF%E7%94%A812.x%E7%89%88%E6%9C%AC%E6%88%96%E8%80%8514.x%E7%89%88%E6%9C%AC%E3%80%82%E9%AB%98%E7%89%88%E6%9C%AC%E6%9C%89bug%E4%B8%8D%E8%80%83%E8%99%91%E4%BA%86%E3%80%82">https://github.com/frida/frida/releases随便下载一个版本，我习惯用12.x版本或者14.x版本。高版本有bug不考虑了。</a></p>
<p>下载好之后放进去Ubuntu解压xz文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xz -d xxxx.tar.xz</span><br></pre></td></tr></table></figure>

<p>这样就得到了so文件了，arm和arm64都下载回来。</p>
<p>添加复制so的脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//源码根目录下，在打开这个文件</span><br><span class="line">/build/make/target/product/handheld_system.mk</span><br><span class="line">//找到PRODUCT_COPY_FILES地方</span><br><span class="line">//myfrida这个目录就是你创建的，你可以随便写自己的。</span><br><span class="line">PRODUCT_COPY_FILES += \</span><br><span class="line">    frameworks/base/cmds/myfrida/frida-gadget-14.2.18-android-arm.so:$(TARGET_COPY_OUT_SYSTEM)/lib/myfrida.so \</span><br><span class="line">    frameworks/base/cmds/myfrida/frida-gadget-14.2.18-android-arm64.so:$(TARGET_COPY_OUT_SYSTEM)/lib64/myfrida.so</span><br></pre></td></tr></table></figure>

<p>加入这个之后，保存文件，编译刷机之后怎么验证是否成功了呢。</p>
<p>adb shell进入system&#x2F;lib和system&#x2F;lib64目录下查看是否存在myfrida.so，这个命名不要和里面的so重名，不然就挂了。</p>
<p>如果你已经做到这一步了，你会发现没有什么用，app启动的时候其实没有注入so的，上面的判断是否持久化没有成立的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Boolean</span> <span class="variable">isPersist</span> <span class="operator">=</span> Persist.isEnablePersist(curPkgName);</span><br></pre></td></tr></table></figure>

<p>这里是没有成立的。分析这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.os.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Persist</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SO_NAME</span> <span class="operator">=</span> <span class="string">&quot;libxiaojianbang.so&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SO_CONFIG_NAME</span> <span class="operator">=</span> <span class="string">&quot;libxiaojianbang.config.so&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIB32_DIR</span> <span class="operator">=</span> <span class="string">&quot;/system/lib&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIB64_DIR</span> <span class="operator">=</span> <span class="string">&quot;/system/lib64&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SETTINGS_DIR</span> <span class="operator">=</span> <span class="string">&quot;/data/system/xsettings/xiaojianbang/persist&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENABLE_PERSIST_FILE_NAME</span> <span class="operator">=</span> <span class="string">&quot;xiaojianbang_persist&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_JS_DIR</span> <span class="operator">=</span> <span class="string">&quot;/data/system/xsettings/xiaojianbang/jscfg&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_JS_FILE_NAME</span> <span class="operator">=</span> <span class="string">&quot;config.js&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG_NAME</span> <span class="operator">=</span> <span class="string">&quot;xiaojianbang_persist&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">LOGD</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.d(TAG_NAME, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">saveFile</span><span class="params">(String filePath, String textMsg)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filePath);</span><br><span class="line">            fileOutputStream.write(textMsg.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            fileOutputStream.flush();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">copyFile</span><span class="params">(File srcFile, File dstFile)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile);</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dstFile);</span><br><span class="line">            <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span> * <span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>((len = fileInputStream.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fileOutputStream.write(data,<span class="number">0</span>, len);</span><br><span class="line">                fileOutputStream.flush();</span><br><span class="line">            &#125;</span><br><span class="line">            fileInputStream.close();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断app是否打开自动注入脚本功能</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isEnablePersist</span><span class="params">(String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断文件是否存在 /data/system/xsettings/xiaojianbang/persist/com.xiaojianbang.app/xiaojianbang_persist</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">enableFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(SETTINGS_DIR, pkgName + File.separator + ENABLE_PERSIST_FILE_NAME);</span><br><span class="line">        <span class="keyword">return</span> enableFile.exists();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取源JS文件路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">getConfigJSPath</span><span class="params">(String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// /data/system/xsettings/xiaojianbang/jscfg/com.xiaojianbang.app/config.js</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(CONFIG_JS_DIR, pkgName + File.separator + CONFIG_JS_FILE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 拷贝源JS文件到app私有目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">copyJSFile</span><span class="params">(Context context, String pkgName)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断源JS文件是否存在</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">srcJSFile</span> <span class="operator">=</span> getConfigJSPath(pkgName);</span><br><span class="line">        <span class="keyword">if</span>(!srcJSFile.exists()) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;srcJSFile not exists&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拷贝源JS文件到app私有目录</span></span><br><span class="line">        <span class="comment">// /data/data/com.xiaojianbang.app/files/config.js</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dstJSFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), CONFIG_JS_FILE_NAME);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isCopyJSOk</span> <span class="operator">=</span> copyFile(srcJSFile, dstJSFile);</span><br><span class="line">        <span class="keyword">if</span>(!isCopyJSOk)&#123;</span><br><span class="line">            LOGD(<span class="string">&quot;copyJSFile fail: &quot;</span> + srcJSFile + <span class="string">&quot; -&gt; &quot;</span> + dstJSFile);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dstJSFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成Gadget配置文件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">genGadgetConfig</span><span class="params">(Context context, File dstJSFile)</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">childObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            childObj.put(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;script&quot;</span>);</span><br><span class="line">            childObj.put(<span class="string">&quot;path&quot;</span>, dstJSFile.toString());</span><br><span class="line">            jsonObject.put(<span class="string">&quot;interaction&quot;</span>, childObj);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">configFilePath</span> <span class="operator">=</span> context.getFilesDir() + File.separator + SO_CONFIG_NAME;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSaveOk</span> <span class="operator">=</span> saveFile(configFilePath, jsonObject.toString());</span><br><span class="line">        <span class="keyword">if</span>(!isSaveOk)&#123;</span><br><span class="line">            LOGD(<span class="string">&quot;saveFile fail: &quot;</span> + configFilePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 拷贝源so文件到app私有目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">copySoFile</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断源so文件是否存在</span></span><br><span class="line">        <span class="comment">// /system/lib/libxiaojianbang.so</span></span><br><span class="line">        <span class="comment">// /system/lib64/libxiaojianbang.so</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">srcSoFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(LIB32_DIR, SO_NAME);</span><br><span class="line">        <span class="keyword">if</span>(Process.is64Bit()) &#123;</span><br><span class="line">            srcSoFile = <span class="keyword">new</span> <span class="title class_">File</span>(LIB64_DIR, SO_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!srcSoFile.exists()) &#123;</span><br><span class="line">            LOGD(<span class="string">&quot;srcSoFile not exists&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拷贝源so文件到app私有目录</span></span><br><span class="line">        <span class="comment">// /data/data/com.xiaojianbang.app/files/libxiaojianbang.so</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dstSoFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), SO_NAME);</span><br><span class="line">        <span class="keyword">if</span>(srcSoFile.length() != dstSoFile.length()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isCopyFileOk</span> <span class="operator">=</span> copyFile(srcSoFile, dstSoFile);</span><br><span class="line">            <span class="keyword">if</span>(!isCopyFileOk)&#123;</span><br><span class="line">                LOGD(<span class="string">&quot;copySoFile fail: &quot;</span> + srcSoFile + <span class="string">&quot; -&gt; &quot;</span> + dstSoFile);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dstSoFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 进行Frida Gadget持久化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">doXiaojianbangPersist</span><span class="params">(Context context, String pkgName)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dstJSFile</span> <span class="operator">=</span> copyJSFile(context, pkgName);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == dstJSFile) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(!genGadgetConfig(context, dstJSFile)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dstSoFile</span> <span class="operator">=</span> copySoFile(context);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == dstSoFile) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        System.load(dstSoFile.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是否激活持久化是这样判断的：<code>判断文件是否存在 </code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/system/xsettings/xiaojianbang/persist/com.xiaojianbang.app/xiaojianbang_persist</span><br></pre></td></tr></table></figure>

<p>这个文件是否存在。仔细发现我们的系统中并没有<code>xsettings</code>这个目录，需要我们创建。</p>
<h5 id="持久化相关的目录"><a href="#持久化相关的目录" class="headerlink" title="持久化相关的目录"></a>持久化相关的目录</h5><p><code>/system/core/rootdir/init.rc</code>在手机启动的时候处理我们需要的目录。</p>
<p>在<code>chown root radio /proc/cmdline</code>下面添加代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/system/xsettings 0775 system system</span><br><span class="line">mkdir /data/system/xsettings/xiaojianbang 0775 system system</span><br><span class="line">mkdir /data/system/xsettings/xiaojianbang/persist 0775 system system</span><br><span class="line">mkdir /data/system/xsettings/xiaojianbang/jscfg 0775 system system</span><br></pre></td></tr></table></figure>

<p>其实不一定要在<code>chown root radio /proc/cmdline</code>下面添加代码，这里的操作无非是创建目录给权限。</p>
<p>只要<code>mkdir /data/system</code>目录创建之后去执行上面的代码就行了，也就是先有父目录，后面就可以创建子目录了。</p>
<p>OK，事情都好像很顺利，开心的编译刷机，然后进入shell中创建目录，持久化文件，app启动的时候注入so成功了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/system/xsettings/xiaojianbang/jscfg/pkgName/config.js</span><br></pre></td></tr></table></figure>

<p>在这里写入hook脚本写成功了。</p>
<p>注意，这里是通过shell去做的，博客也没有说，我是这样先做注入测试的。</p>
<p>我们需要针对某个app进行持久化hook每次都这样手动进入shell去设置是有点麻烦的，能不能开发一个app来做这件事：</p>
<p>1：查看当前用户安装的app列表。</p>
<p>2：选择某个app配置js脚本。js脚本也可能多个，做列表来显示多个脚本，可以选择其中一个来hook。</p>
<p>3：是否激活持久化hook。</p>
<p>写app嘛，老本行了，说干就干。</p>
<h5 id="编写管理脚本的app"><a href="#编写管理脚本的app" class="headerlink" title="编写管理脚本的app"></a>编写管理脚本的app</h5><p>需求已经明确了，开始撸码。</p>
<p>根据上面<code>Persist</code>这个类的规则，我们想激活某个app进行持久化hook就需要在<code>/data/system/xsettings/xiaojianbang/persist/pkgName/xiaojianbang_persist</code>这里有一个文件，举个例子：</p>
<p>包名是com.demo。就需要在<code>/data/system/xsettings/xiaojianbang/persist</code> 下创建目录<code>com.demo</code>切在目录中创建一个文件，空文件就行。</p>
<p>最后是这样： <code>/data/system/xsettings/xiaojianbang/persist/com.demo/xiaojianbang_persist</code></p>
<p>创建目录和创建文件都不难，这里会出问题，我们直接写app创建是没有权限的，普通用户的app无法操作系统目录。</p>
<p>那如果我们也是系统级app呢？这就到了AOSP内置apk的问题了。</p>
<p>我的哔站有视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1S14y1K7Ew">https://www.bilibili.com/video/BV1S14y1K7Ew</a></p>
<p>我的公众号：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/c9TT25UR5JCmTHFOXRVnvQ">https://mp.weixin.qq.com/s/c9TT25UR5JCmTHFOXRVnvQ</a></p>
<p>这个管理的app是无so的，直接复制脚本就行了。签名使用<code>platform</code>。</p>
<p>编译apk的时候需要在配置文件<code>AndroidMainfest.xml</code>中加入<code>android:sharedUserId=&quot;android.uid.system&quot;</code>这样app有系统权限了。</p>
<p>一切都很美好~，创建目录，创建文件。。。<code>Permission Denial</code></p>
<p>还是没有权限。。。</p>
<h5 id="配置新增目录的SEPolicy"><a href="#配置新增目录的SEPolicy" class="headerlink" title="配置新增目录的SEPolicy"></a>配置新增目录的SEPolicy</h5><p>这里需要配置的内容就比较多了，下一篇给出全部配置代码。</p>
<p>欢迎关注公众号：黄大官AOSP<br><img src="https://book.debuglive.cn/gzh/ic_gzh.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://me.debuglive.cn/2023/11/06/AOSP%20Android%2010%E5%86%85%E7%BD%AEFridaGadget%E5%AE%9E%E8%B7%B501/" data-id="cloqkxoj80000a7sm10dd31o2" data-title="AOSP Android 10内置FridaGadget实践01" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AOSP/" rel="tag">AOSP</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/11/06/AOSP%20Android%2010%E5%86%85%E7%BD%AEFridaGadget%E5%AE%9E%E8%B7%B502/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          AOSP Android 10内置FridaGadget实践02
        
      </div>
    </a>
  
  
    <a href="/2023/11/06/AOSP%20Android%2010%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91%E5%88%B7%E5%85%A5Pixel3/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">AOSP Android 10内核编译刷入Pixel3</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android-AOSP%E5%AD%A6%E4%B9%A0/">Android AOSP学习</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOSP/" rel="tag">AOSP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AOSP/" style="font-size: 20px;">AOSP</a> <a href="/tags/Android/" style="font-size: 10px;">Android</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/11/13/Android%20Studio%E9%85%8D%E7%BD%AEollvm%E7%BC%96%E8%AF%91so/">Android Studio配置ollvm编译so</a>
          </li>
        
          <li>
            <a href="/2023/11/06/AOSP%20Android%2010%E5%86%85%E7%BD%AEFridaGadget%E5%AE%9E%E8%B7%B502/">AOSP Android 10内置FridaGadget实践02</a>
          </li>
        
          <li>
            <a href="/2023/11/06/AOSP%20Android%2010%E5%86%85%E7%BD%AEFridaGadget%E5%AE%9E%E8%B7%B501/">AOSP Android 10内置FridaGadget实践01</a>
          </li>
        
          <li>
            <a href="/2023/11/06/AOSP%20Android%2010%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91%E5%88%B7%E5%85%A5Pixel3/">AOSP Android 10内核编译刷入Pixel3</a>
          </li>
        
          <li>
            <a href="/2023/11/06/AOSP%20Android%2010%E5%AF%BC%E5%85%A5BurpSuite%20CA%E8%AF%81%E4%B9%A6%E6%8A%93%E5%8C%85/">AOSP Android 10导入BurpSuite CA证书抓包</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 黄大官AOSP<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>